# 招待コードシステム管理ガイド

## 概要

招待コードシステムは、ユーザーがOpenRouterアカウントを持たなくても、事前に設定された招待コードを使用してAIモデルにアクセスできる機能です。

## セキュリティ上の重要事項

- **招待コード管理ファイル (`config/invite-codes.json`) は絶対にGitにコミットしないでください**
- 本番環境では環境変数や安全な設定管理システムを使用してください
- APIキーは絶対にクライアント側に露出させないでください

## 招待コードの追加・更新

### 1. 設定ファイルの編集

`config/invite-codes.json` ファイルを編集して新しい招待コードを追加します：

```json
{
  "codes": {
    "NEW-CODE-789": "sk-or-v1-your-actual-api-key-here",
    "EXISTING-CODE-123": "sk-or-v1-example-api-key-123"
  }
}
```

### 2. 招待コードの形式

- 大文字小文字は区別されません（ユーザーフレンドリー）
- ハイフンやアンダースコアを含むことができます
- 推奨形式: `PURPOSE-RANDOM-123` (例: `DEMO-ACCESS-456`, `TRIAL-USER-789`)

### 3. 本番環境での管理

本番環境では、以下のような方法で招待コードを管理することを推奨します：

#### 環境変数を使用する場合

```typescript
// app/api/invite-code/validate/route.ts の修正例
const inviteCodes = process.env.INVITE_CODES 
  ? JSON.parse(process.env.INVITE_CODES) 
  : require("@/config/invite-codes.json").codes;
```

環境変数の設定例：
```bash
INVITE_CODES='{"DEMO-123":"sk-or-v1-xxx","TRIAL-456":"sk-or-v1-yyy"}'
```

#### データベースを使用する場合

招待コードとAPIキーのマッピングをデータベースに保存し、動的に管理することも可能です。

## 使用制限の実装（オプション）

招待コードに使用制限を設けたい場合は、以下のような拡張が可能です：

1. **使用回数制限**: 各招待コードの使用回数をトラッキング
2. **有効期限**: 招待コードに有効期限を設定
3. **レート制限**: 招待コード毎のAPI呼び出し回数を制限

## トラブルシューティング

### 招待コードが機能しない場合

1. `config/invite-codes.json` ファイルが正しい形式であることを確認
2. APIキーが有効であることを確認
3. サーバーログでエラーメッセージを確認

### プロキシAPIがタイムアウトする場合

1. OpenRouterのAPIキーが有効であることを確認
2. ネットワーク接続を確認
3. OpenRouterのステータスページで障害情報を確認

## セキュリティベストプラクティス

1. **定期的なAPIキーのローテーション**: 定期的にAPIキーを更新
2. **アクセスログの監視**: 招待コードの使用状況を監視
3. **異常検知**: 異常な使用パターンを検出してアラート
4. **HTTPS必須**: APIエンドポイントへのアクセスは必ずHTTPS経由で

## 今後の拡張案

1. **管理画面**: 招待コードをWeb UIから管理できる機能
2. **使用統計**: 各招待コードの使用状況を可視化
3. **ユーザー管理**: 招待コードとユーザーアカウントの紐付け
4. **カスタム制限**: モデルやトークン数の制限をコード毎に設定